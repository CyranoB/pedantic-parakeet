---
phase: 01-mlx-audio-backend
plan: 02
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - pedantic_parakeet/backends/parakeet.py
  - pedantic_parakeet/backends/mlx_audio.py
  - pedantic_parakeet/transcriber.py
  - pyproject.toml
autonomous: true
must_haves:
  truths:
    - "Parakeet backend behavior matches existing transcription output"
    - "mlx-audio backend can load curated models without breaking the CLI"
    - "Missing mlx-audio dependency produces a clear install error"
  artifacts:
    - path: "pedantic_parakeet/backends/parakeet.py"
      provides: "Parakeet backend implementation"
    - path: "pedantic_parakeet/backends/mlx_audio.py"
      provides: "mlx-audio backend implementation with dependency guard"
    - path: "pedantic_parakeet/transcriber.py"
      provides: "Backend factory and facade"
    - path: "pyproject.toml"
      provides: "mlx-audio optional dependency group"
  key_links:
    - from: "pedantic_parakeet/transcriber.py"
      to: "pedantic_parakeet/backends/registry.py"
      via: "model selection"
      pattern: "resolve_.*model"
    - from: "pedantic_parakeet/backends/mlx_audio.py"
      to: "mlx_audio.stt"
      via: "load"
      pattern: "mlx_audio\.stt"
---

<objective>
Implement backend adapters for Parakeet and mlx-audio, and wire them into the Transcriber facade.

Purpose: Enable backend selection while preserving existing CLI behavior.
Output: Backend adapters, factory wiring, and optional dependency metadata.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/codebase/STRUCTURE.md
@.planning/codebase/ARCHITECTURE.md
@pedantic_parakeet/transcriber.py
@pedantic_parakeet/formatters.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Parakeet backend and add Transcriber factory</name>
  <files>pedantic_parakeet/backends/parakeet.py, pedantic_parakeet/transcriber.py</files>
  <action>
    - Move current Parakeet-specific logic from `Transcriber` into a new `ParakeetBackend` class implementing `BaseTranscriber`.
    - Keep `Token`, `Segment`, and `TranscriptionResult` dataclasses in `transcriber.py` unchanged to preserve formatter compatibility.
    - Update `transcriber.py` to include a backend factory (`create_backend` or similar) that uses `resolve_model` from the registry and accepts an optional `backend` override.
    - Update `Transcriber` to delegate to the selected backend instance while preserving the existing constructor signature (add optional `backend` parameter with default `None`).
    - Keep Parakeet language bias behavior identical to the current implementation.
  </action>
  <verify>python -c "from pedantic_parakeet.transcriber import Transcriber; Transcriber()"</verify>
  <done>Transcriber still works with the default model and routes through the Parakeet backend.</done>
</task>

<task type="auto">
  <name>Task 2: Implement mlx-audio backend + optional dependency</name>
  <files>pedantic_parakeet/backends/mlx_audio.py, pyproject.toml</files>
  <action>
    - Create `MlxAudioBackend` implementing `BaseTranscriber` and lazily import `mlx_audio` (use `TYPE_CHECKING` to avoid import errors at module import time).
    - If `mlx_audio` is missing, raise a `RuntimeError` with install guidance: `pip install pedantic-parakeet[mlx-audio]`.
    - Load models with `from mlx_audio.stt import load` and cache the model instance.
    - Map options by capability:
      - If `supports_language_hint` and `language` is set, pass `language` to `model.generate`.
      - If `supports_chunking`, pass `chunk_duration` and `overlap_duration` to `model.generate`.
      - For Whisper models, pass `word_timestamps=True` to obtain word timings when timestamps are supported.
    - Convert outputs into `TranscriptionResult`:
      - If result has `segments`, map each segment to `Segment` and optional word-level tokens from `segment.get("words", [])`.
      - If result has `sentences`, map aligned sentences/tokens into `Segment`/`Token` values.
      - If no timestamps exist, return a `TranscriptionResult` with empty `segments`.
    - Add optional dependency group in `pyproject.toml`:
      - `mlx-audio = ["mlx-audio>=0.2.5"]`
      - `all = ["mlx-audio>=0.2.5"]` (optional convenience extra).
  </action>
  <verify>python -c "import pedantic_parakeet.backends.mlx_audio"</verify>
  <done>mlx-audio backend module imports without failing when the dependency is absent and emits a clear error if instantiated without the extra.</done>
</task>

</tasks>

<verification>
- `python -c "from pedantic_parakeet.transcriber import Transcriber; Transcriber()"` succeeds.
- If mlx-audio is installed: `python -c "from pedantic_parakeet.backends.mlx_audio import MlxAudioBackend; MlxAudioBackend(model_id='mlx-community/whisper-large-v3-turbo-asr-fp16')"` initializes.
</verification>

<success_criteria>
- Parakeet backend remains the default with unchanged output structure.
- mlx-audio backend loads curated models and returns `TranscriptionResult` instances.
- Optional dependency is declared and missing installs produce clear guidance.
</success_criteria>

<output>
After completion, create `.planning/phases/01-mlx-audio-backend/01-02-SUMMARY.md`
</output>

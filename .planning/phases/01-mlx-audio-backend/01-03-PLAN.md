---
phase: 01-mlx-audio-backend
plan: 03
type: execute
wave: 3
depends_on:
  - "01-02"
files_modified:
  - pedantic_parakeet/cli.py
  - README.md
  - tests/test_cli.py
  - tests/test_backends.py
autonomous: true
must_haves:
  truths:
    - "Users can list curated models and select a backend with CLI flags"
    - "Models without timestamps reject srt/vtt/json outputs"
    - "Unsupported language options fail with actionable errors"
  artifacts:
    - path: "pedantic_parakeet/cli.py"
      provides: "Backend selection flags and validation"
    - path: "tests/test_backends.py"
      provides: "Registry and capability validation tests"
    - path: "tests/test_cli.py"
      provides: "CLI coverage for backend and format validation"
    - path: "README.md"
      provides: "Backend usage and optional install docs"
  key_links:
    - from: "pedantic_parakeet/cli.py"
      to: "pedantic_parakeet/backends/registry.py"
      via: "model resolution and listing"
      pattern: "list_models|resolve_model"
    - from: "pedantic_parakeet/cli.py"
      to: "pedantic_parakeet/transcriber.py"
      via: "Transcriber initialization"
      pattern: "Transcriber\("
---

<objective>
Expose backend selection in the CLI, validate output constraints, and add test coverage/documentation.

Purpose: Make mlx-audio support discoverable and safe for end users.
Output: CLI flags, validations, tests, and updated README guidance.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/codebase/STRUCTURE.md
@.planning/codebase/ARCHITECTURE.md
@pedantic_parakeet/cli.py
@pedantic_parakeet/transcriber.py
@pedantic_parakeet/formatters.py
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI backend flags, validation, and docs</name>
  <files>pedantic_parakeet/cli.py, README.md</files>
  <action>
    - Add `--backend` option with choices `parakeet` and `mlx-audio` (default: auto via registry).
    - Add `--list-models` flag to print curated models with backend + timestamp support and exit before transcribing.
    - Resolve `model_id` via the registry before instantiating `Transcriber` to avoid importing mlx-audio unnecessarily.
    - Validate formats: if `supports_timestamps` is false and any of `srt`, `vtt`, or `json` are requested, raise `typer.BadParameter` instructing users to use `txt` or another model.
    - Validate language options:
      - If `language_strength` is non-default and the model lacks `supports_language_bias`, raise a `BadParameter` explaining the limitation.
      - If `language` is set but the model supports neither `supports_language_bias` nor `supports_language_hint`, raise a `BadParameter` with allowed models.
    - Pass `backend` into `Transcriber` when creating it.
    - Update README usage section with:
      - Optional install: `pip install pedantic-parakeet[mlx-audio]`.
      - Example: `--backend mlx-audio --model mlx-community/whisper-large-v3-turbo-asr-fp16`.
      - `--list-models` description and note that Voxtral outputs text-only (txt required).
  </action>
  <verify>python -m pedantic_parakeet.cli --list-models</verify>
  <done>CLI exposes backend selection/listing and rejects unsupported formats or options.</done>
</task>

<task type="auto">
  <name>Task 2: Add registry + CLI validation tests</name>
  <files>tests/test_backends.py, tests/test_cli.py</files>
  <action>
    - Add `tests/test_backends.py` to validate curated registry resolution, backend assignment, and `ValueError` on unknown model IDs.
    - Extend `tests/test_cli.py`:
      - `--list-models` shows curated model IDs.
      - Voxtral model with `--format srt` errors before instantiating the backend.
      - `--language-strength` with mlx-audio models raises a validation error.
    - Keep tests independent of the optional `mlx-audio` dependency by ensuring validation runs before backend instantiation.
  </action>
  <verify>pytest tests/test_backends.py tests/test_cli.py</verify>
  <done>Tests cover registry resolution and CLI validation without requiring mlx-audio installed.</done>
</task>

</tasks>

<verification>
- `python -m pedantic_parakeet.cli --list-models` prints curated list.
- `pytest tests/test_backends.py tests/test_cli.py` passes.
</verification>

<success_criteria>
- Users can discover supported models and select a backend via CLI.
- Text-only models reject srt/vtt/json outputs with clear errors.
- CLI validation covers unsupported language options without importing mlx-audio.
</success_criteria>

<output>
After completion, create `.planning/phases/01-mlx-audio-backend/01-03-SUMMARY.md`
</output>
